# PH1-02: 禁則判定ロジック第1弾を実装する

## 1. メタ情報
- **タスクID**: PH1-02
- **タイトル**: 禁則判定サービス実装（並行5度/8度など）
- **フェーズ**: Phase1
- **カテゴリ**: Backend / Domain
- **担当**: _(TBD)_
- **ステータス**: Planned
- **関連Issue/PR**: ADR (PH1-01) を参照

## 2. 背景・目的
- ADRで合意したルールを実装し、課題提出APIの評価基盤を整える。
- MVP範囲として代表的な禁則を検出できるようにする。

## 3. ゴールと非ゴール
- **ゴール**
  - 並行五度/八度、13音、重複調的進行など優先度高い禁則を判定。
  - ユニットテストで期待動作を保証。
- **非ゴール**
  - 推奨進行やコメント生成（Phase2）。

## 4. スコープ詳細
- **対象コード**: `backend/services/` 下の新規禁則判定サービス、必要なら `models/`.
- **参照**: PH1-01 ADR。

## 5. 実施ステップ
1. ADR通りの入力DTO（例: 声部ごとの音列）を受け取る関数を実装。
2. 各禁則チェックを個別メソッドに分け、テスト可能にする。
3. 例外・ログの方針を決定。
4. pytestで正常系/異常系テストを作成。

## 6. 成果物
- サービス実装コード。
- pytest（最低でも各禁則ごとのテスト）。

## 7. 依存・ブロッカー
- **前提**: PH1-01完了。
- **考慮事項**: 音高表現（MIDI, 音名+オクターブ）の仕様決定が必要。

## 8. リスクと対策
| リスク | 影響 | 対策 |
| --- | --- | --- |
| 音楽理論の解釈差異 | 判定結果が期待とずれる | ドメイン担当にテストケースをレビューしてもらう |
| 性能問題 | 大規模進行で遅延 | MVPでは固定長(4声)に絞る |

## 9. テスト・検証
- `pytest`：Positive/Negativeケース。
- 受入基準: 主要禁則が検出され、false positive/negativeが許容範囲。

## 10. 計測
- 任意で実行時間をログに出しておく。

## 11. ドキュメント
- `docs/domain/` に禁則リストを追記すると良い。

## 12. タイムライン
- TBD

## 13. チェックリスト
- [ ] サービス骨子実装
- [ ] 各禁則ロジック実装
- [ ] pytest追加
- [ ] ドメインレビュー
- [ ] PRマージ

---
**考慮事項**: 今後ルールを追加する際の拡張性（Strategyパターン等）を検討。
