# 開発ガイドライン

## 設計プロセス

### 1. ADR（Architecture Decision Record）
- 新機能の実装前に必ずADRを作成
- `docs/ADR/` 配下に配置
- テンプレート: `docs/adr_template.md` を使用
- 以下の項目を必ず含める：
  - コンテキストと要件
  - 決定事項と根拠
  - 代替案の検討
  - 影響範囲
  - 妥協点・技術的負債

### 2. ドメイン知識の文書化
- `docs/domain/` 配下に配置
- 業務知識・用語の定義
- 制約・ルール
- 将来の拡張可能性
- 参考文献・出典

### 3. 言語間の一貫性
- Python/TypeScript間でのモデル定義の同期
- 共通の型定義・バリデーションルール
- コードジェネレータの活用（必要に応じて）
- スキーマ定義の一元管理

## 実装プロセス

### 1. テスト駆動開発（TDD）
- テストファースト原則
- Red-Green-Refactorサイクルの遵守
- テストケースの優先順位：
  1. バリデーションテスト
  2. コアロジックテスト
  3. エッジケーステスト
  4. 異常系テスト

### 2. テストの一貫性
- Python（pytest）とTypeScript（Jest）で同等のテストケース
- テストケース命名規則の統一
- テストデータの共有
- カバレッジ目標：80%以上

### 3. バリデーション
- 入力値の検証（Pydantic, Zod等）
- ビジネスルールの検証
- エラーメッセージの一貫性
- 国際化対応

## レビュープロセス

### 1. プルリクエスト提出前
- [ ] ADRが作成・更新されているか
- [ ] ドメイン知識が文書化されているか
- [ ] テストが十分に書かれているか
- [ ] バリデーションが適切か
- [ ] 両言語で一貫性が保たれているか
- [ ] 将来の拡張性が考慮されているか

### 2. レビュー時の確認事項
- [ ] ADRの内容は適切か
- [ ] テストケースは十分か
- [ ] エッジケースは考慮されているか
- [ ] バリデーションは完全か
- [ ] 言語間の一貫性は保たれているか
- [ ] コードの品質は基準を満たしているか

## コードの品質基準

### 1. テストカバレッジ
- 全体のカバレッジ：80%以上
- 重要なビジネスロジック：100%
- 異常系のテスト：必須

### 2. 静的解析
- Python: ruff, mypy
- TypeScript: ESLint, TypeScript Compiler
- Prettier

### 3. パフォーマンス
- バリデーション処理の効率性
- メモリ使用量の最適化
- 処理時間の目標値設定

## ドキュメント更新プロセス

### 1. ADRの更新
- 重要な決定事項の追加
- 既存の決定の変更・破棄
- 影響範囲の更新

### 2. ドメイン知識の更新
- 新しい概念・ルールの追加
- 既存の定義の明確化・修正
- 参考文献の追加

### 3. ガイドラインの見直し
- 四半期ごとのレビュー
- チームフィードバックの反映
- ベストプラクティスの更新

## 開発環境とツールチェーン

### 1. 環境セットアップ
- **WSL環境での開発**
  - WSLでの出力問題対策
    - 代替コマンドの用意（例：`python -u`の使用）
    - ログファイルへの出力活用
    - VSCode Remote WSLの設定最適化
  - パス解決の注意点
    - 絶対パスの使用
    - パスセパレータの統一（POSIXスタイル推奨）
  - 環境変数の管理
    - `.env`ファイルの利用
    - WSL固有の環境変数設定

### 2. CI/CDツールチェーン
- **検証コマンドリファレンス**

  **フロントエンド検証**
  ```bash
  # 依存関係の更新と整合性確認
  cd frontend
  rm -rf node_modules package-lock.json
  npm install --legacy-peer-deps

  # ESLintによるコード品質チェック
  npm run lint
  # または詳細なレポート出力
  npx eslint . --ext .js,.jsx,.ts,.tsx --report-unused-disable-directives

  # Prettierによるコードフォーマットチェック
  npx prettier --check "src/**/*.{ts,tsx}"
  # フォーマット適用
  npx prettier --write "src/**/*.{ts,tsx}"

  # TypeScript型チェック
  npm run type-check
  # または詳細オプション付き
  npx tsc --noEmit --incremental false

  # テスト実行
  npm test
  # カバレッジレポート付き
  npm test -- --coverage
  ```

  **バックエンド検証**
  ```bash
  # 仮想環境の再作成と依存関係の更新
  cd backend
  source .venv/bin/activate  # Windows WSLの場合
  uv pip install -e ".[dev,test]"
  uv sync --all-extras

  # ruffによるコード品質チェック
  ruff check .
  # 自動修正
  ruff check . --fix

  # ruffによるフォーマットチェック
  ruff format --check .
  # フォーマット適用
  ruff format .

  # mypyによる型チェック（詳細出力）
  mypy . --show-error-codes --pretty

  # pytestによるテスト実行
  pytest
  # カバレッジレポート付き
  pytest --cov=. --cov-report=term-missing
  # 詳細出力とログ表示
  pytest -v --log-cli-level=INFO
  ```

  **WSL環境でのデバッグ用追加コマンド**
  ```bash
  # Pythonバッファリング無効化（出力問題対策）
  python -u -m pytest

  # ログファイルへの出力
  pytest --log-file=test.log

  # エラー発生時のPDB起動
  pytest --pdb

  # WSLでのパス問題のデバッグ
  realpath .  # 現在の絶対パスを表示
  pwd  # 現在のディレクトリを表示
  ```

- **CI実行前のローカルチェックリスト**
  1. 最新のmainブランチを取り込んでいることを確認
  2. 依存関係を最新化
  3. 全検証コマンドを順次実行
  4. すべてのチェックがパスすることを確認
  5. コミット前にpre-commitフックが正常に動作することを確認

### 3. デバッグとトラブルシューティング
- **ログ・エラー解析**
  - エラーメッセージの完全な取得
  - スタックトレースの保存
  - 環境情報の記録
- **再現手順の文書化**
  - 環境・バージョン情報
  - 実行コマンド
  - 期待される結果
  - 実際の結果
- **解決策の共有**
  - トラブルシューティングガイドの更新
  - ナレッジベースへの追加
  - レビュー時の注意点として共有

### 4. 定期的なメンテナンス
- **依存関係の更新**
  - 定期的なアップデートチェック
  - 破壊的変更の確認
  - テストスイートでの検証
- **設定ファイルの見直し**
  - linterルールの最適化
  - CI/CD設定の効率化
  - 型チェック設定の調整
- **テストカバレッジの監視**
  - 定期的なカバレッジレポート確認
  - 不足箇所の特定と補完
  - テスト品質の向上

## 開発の教訓と改善点

### 1. コンポーネント設計
- **export/importの統一**
  - プロジェクト全体で一貫した方式を採用（named exportまたはdefault export）
  - 初期設計時に方針を明確化
  - コンポーネントとテストで同じ方式を使用

- **Reactコンポーネントの構造化**
  - Router周りのテスト実装ベストプラクティスの共有
  - コンポーネントの責務を明確に分離
  - テスト可能性を考慮した設計

### 2. テスト実装の品質向上
- **テストのベストプラクティス文書化**
  - 非同期処理（waitFor等）の適切な使用方法
  - Router/Reduxのテスト方法
  - モックの使用指針

- **テストケース設計**
  - 実装前のテストケース設計レビュー
  - エッジケースの網羅
  - テストデータの共有・再利用

### 3. CI/CD運用の効率化
- **ローカルでの事前チェック徹底**
  - コミット前のLint/Format/型チェック実行
  - テストの完全実行
  - git statusでの変更確認

- **CIエラーへの対応**
  - ローカルでの再現確認
  - エラーパターンとその解決方法の文書化
  - チーム内での知見共有

### 4. コミット規約の遵守
- **メッセージフォーマット**
  - 「動詞: 内容」の形式
  - 1行50文字以内
  - 明確な変更内容の記載

- **コミット粒度**
  - 1つの機能変更につき1コミット
  - 関連する変更のグループ化
  - 不要なファイルの混入防止

### 5. ドキュメンテーション
- **リアルタイムな更新**
  - 設計変更時の即時反映
  - ADRの継続的なメンテナンス
  - チーム内での知見共有

- **ベストプラクティスの蓄積**
  - 問題解決パターンの文書化
  - トラブルシューティングガイドの整備
  - レビュー指摘事項の集約
